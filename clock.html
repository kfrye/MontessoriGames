<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript" src="http://code.createjs.com/createjs-2013.12.12.min.js"></script>

    <script>
        var stage, clockContainer, min, hr;
        var stageWidth = 640;
        var stageHeight = 480;
        var clockRadius = 150;
        var buttonWidth = 150;
        var timeLabel;
        var clock;

        function ClockNumber(hour, min) {
            this.hour = hour;
            this.min = min;
        }

        function init() {
            stage = new createjs.Stage("demo"); // points to the canvas element in html body

            createClock();
            createSubmitButton();
            createNewClockButton();

            var instructions = new createjs.Text("Set the clock:", "bold 25px Arial", "#0066CC");
            var b = instructions.getBounds();
            instructions.x = stage.canvas.width/2 - b.width/2;
            instructions.y = 20;
            stage.addChild(instructions);

            // Add a randomly generated time to the screen
            clock = generateTime();
            timeLabel = new createjs.Text(clock.hour + ":" + clock.min, "bold 30px Arial", "#CC3300" );
            b = timeLabel.getBounds();
            timeLabel.x = stage.canvas.width/2 - b.width/2;
            timeLabel.y = 60;
            stage.addChild(timeLabel);
 
            stage.update();
        }

        // add the clock to the canvas
        function createClock() {
            clockContainer = stage.addChild(new createjs.Container()); // container to hold the clock
            clockContainer.x = stage.canvas.width/2;
            clockContainer.y = stage.canvas.height/2;

            // Add clock minute markers
            for(deg = 0; deg <= 360; deg+= 6) {
                var marker = new createjs.Shape();
                marker.graphics.beginFill("black").drawCircle(clockRadius,0,1);
                marker.rotation = deg;
                clockContainer.addChild(marker);
            }

            // Add clock minute hand
            min = new createjs.Shape();
            min.graphics.beginFill("black").drawRect(0,0, clockRadius - 15, 5);
            min.on("pressmove", clickHandler);
            clockContainer.addChild(min);
            min.rotation = 315; // starting position for the minute hand
            console.log(min.rotation);

            // Add clock hour hand
            hr = new createjs.Shape();
            hr.graphics.beginFill("black").drawRect(0,0, clockRadius/2, 7);
            hr.on("pressmove", clickHandler);
            clockContainer.addChild(hr);
            hr.rotation = 225; // starting position for the hour hand
            drawNumbers();
        }

        // Add the submit button to the canvas
        function createSubmitButton() {
            var submitContainer = new createjs.Container();
            submitContainer.y = stage.canvas.height/2 + clockRadius + 50;
            submitContainer.x = stage.canvas.width/2 - buttonWidth - 30;
            stage.addChild(submitContainer);

            var submitButton = new createjs.Shape();
            submitButton.graphics.beginFill("#0066CC").drawRoundRect(0,0, buttonWidth, 40, 2 );
            submitButton.on("click", submitButtonClickHandler);
            submitContainer.addChild(submitButton);

            var submitText = new createjs.Text("Submit", "bold 25px Arial", "white");
            submitText.textAlign = "center";
            submitText.textBaseline = "middle";
            submitText.x = buttonWidth/2;
            submitText.y = 20;
            submitContainer.addChild(submitText);
        }

        // Add the 'New Clock' button to the canvas
        function createNewClockButton() {
            var newClockContainer = new createjs.Container();
            newClockContainer.y = stage.canvas.height/2 + clockRadius + 50;
            newClockContainer.x = stage.canvas.width/2 + 30;
            stage.addChild(newClockContainer);

            var newClockButton = new createjs.Shape();
            newClockButton.graphics.beginFill("#CC3300").drawRoundRect(0,0, buttonWidth, 40, 2 );
            newClockButton.on("click", newClockButtonClickHandler);
            newClockContainer.addChild(newClockButton);

            var newClockText = new createjs.Text("New Clock", "bold 25px Arial", "white");
            newClockText.textAlign = "center";
            newClockText.textBaseline = "middle";
            newClockText.x = buttonWidth/2;
            newClockText.y = 20;
            newClockContainer.addChild(newClockText);
        }

        function submitButtonClickHandler(event) {
            var hourDeg = hr.rotation;
            var minDeg = min.rotation;
            console.log("Hour angle: " + hourDeg + " Min angle: "+minDeg);
            var hourNum = determineClockNumber(hourDeg);
            var minNum = determineClockNumber(minDeg);
            if(minNum == 12)
               minNum = 0;
            else
               minNum = minNum * 5;
            console.log("Hour: " + hourNum + " Min: " + minNum);
            if(minNum == clock.min) {
                if(clock.min == 0 && clock.hour == hourNum)
                    console.log("You win!");
                else if(clock.min == 15 &&
                    (clock.hour == hourNum || clock.hour == hourNum))
                    console.log("You win!");
                else if(clock.min == 30 &&
                        (clock.hour == hourNum || clock.hour +.5 == hourNum))
                    console.log("You win!");
                else if(clock.min == 45 &&
                    (clock.hour == (hourNum + 1) % 12 || clock.hour == hourNum))
                    console.log("You win!");
            }
            else
                console.log("try again"); 
        } 
  
        function newClockButtonClickHandler(event) {

        }

        function drawNumbers(){
            var numbers=[1,2,3,4,5,6,7,8,9,10,11,12];

            function toRadians (angle) {
                return angle * (Math.PI / 180);
            }

            function place_numbers(number){
                var placement=((number%12/12)*360);
                var text=new createjs.Text(number.toString(),"25px Arial","#000");
                text.textBaseline="middle";
                text.textAlign="center";
                text.x=stage.canvas.width/2;
                text.y=stage.canvas.height/2;
                var r=170;
                var x=r*Math.sin(toRadians(placement));
                var y=r*Math.cos(toRadians(placement));
                console.log(number,placement,x,y);
                text.regX=-x;
                text.regY=y;
                stage.addChild(text);
                stage.update();
            }

            for (num in numbers)
                place_numbers(numbers[num]);
        }

        function clickHandler(event) {
            var dx = stage.mouseX - clockContainer.x;
            var dy = stage.mouseY - clockContainer.y;
            var angle = getAngle(dx, dy); 
            var clockNum = determineClockNumber(angle);

            console.log("Angle: " + angle + " clock num: " + clockNum);
            event.target.rotation = angle;

            stage.update();
        }

        // Get the angle of rotation for the given x,y coordinants relative
        // to the x-axis
        function getAngle(x, y) {
            var angle = Math.atan2(y, x);
            angle = angle * (180/Math.PI);
            if(angle < 0)
            {
                angle = 360 - (-angle);
            }
            return angle;
        }

        // Given an angle (in degrees), find the clock number 
        function determineClockNumber(degree) {
            var num = degree/30 + 3;
            var frac = num % 1;

            if(frac < .25) {
                num -= frac;
            }
            else if(frac >= .25 && frac < .75) {
                num -= frac;
                num += .5;
            }
            else if(frac >= .75) {
                num -= frac;
                num++;
            }
            if(num > 12.5)
                num -= 12;
            return num;
        }

        // Generate a random time and return a ClockNumber object       
        function generateTime() {
            var hour = Math.floor((Math.random() * 12) + 1);
            var minArray = [00, 15, 30, 45];
            var minIndex = Math.floor((Math.random() * 4));
            var min = minArray[minIndex];
            var clock = new ClockNumber(hour, min);
            console.log(hour + ":" + min);
            return clock;
        }
    </script>
</head>
<body onLoad="init();">
<canvas id="demo" width="480" height="640">
</canvas>
</body>
</html>
